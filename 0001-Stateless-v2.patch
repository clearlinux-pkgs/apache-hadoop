From f03fbb618cf823dabbbde3efb6d86aa0c6202faf Mon Sep 17 00:00:00 2001
From: Athenas Jimenez Gonzalez <athenas.jimenez.gonzalez@intel.com>
Date: Mon, 2 Oct 2017 17:13:52 +0000
Subject: [PATCH] Stateless v2

---
 .../hadoop-common/src/main/bin/hadoop-config.sh           | 15 +++++++++++----
 .../hadoop-common/src/main/bin/hadoop-daemon.sh           |  2 +-
 .../hadoop-kms/src/main/libexec/kms-config.sh             |  2 +-
 .../hadoop-hdfs-httpfs/src/main/libexec/httpfs-config.sh  |  2 +-
 hadoop-mapreduce-project/bin/mapred-config.sh             |  2 +-
 hadoop-yarn-project/hadoop-yarn/bin/yarn                  |  2 +-
 hadoop-yarn-project/hadoop-yarn/bin/yarn-config.sh        |  7 ++++++-
 hadoop-yarn-project/hadoop-yarn/bin/yarn-daemon.sh        |  2 +-
 hadoop-yarn-project/hadoop-yarn/conf/yarn-env.sh          |  2 +-
 9 files changed, 24 insertions(+), 12 deletions(-)

diff --git a/hadoop-common-project/hadoop-common/src/main/bin/hadoop-config.sh b/hadoop-common-project/hadoop-common/src/main/bin/hadoop-config.sh
index fc41f7f..f60d78e 100644
--- a/hadoop-common-project/hadoop-common/src/main/bin/hadoop-config.sh
+++ b/hadoop-common-project/hadoop-common/src/main/bin/hadoop-config.sh
@@ -100,12 +100,19 @@ HADOOP_LOGLEVEL="${HADOOP_LOGLEVEL:-INFO}"
  
 # Allow alternate conf dir location.
 if [ -e "${HADOOP_PREFIX}/conf/hadoop-env.sh" ]; then
-  DEFAULT_CONF_DIR="conf"
+  DEFAULT_CONF_DIR="$HADOOP_PREFIX/conf"
+elif [ -e "/etc/hadoop" ]; then
+  DEFAULT_CONF_DIR="/etc/hadoop"
+  if [ -z "$(ls -A /etc/hadoop)" ]; then
+      echo \
+          "Error: Directory /etc/hadoop is empty"
+      exit 1
+  fi
 else
-  DEFAULT_CONF_DIR="etc/hadoop"
+  DEFAULT_CONF_DIR="/usr/share/defaults/hadoop"
 fi
 
-export HADOOP_CONF_DIR="${HADOOP_CONF_DIR:-$HADOOP_PREFIX/$DEFAULT_CONF_DIR}"
+export HADOOP_CONF_DIR="${HADOOP_CONF_DIR:-$DEFAULT_CONF_DIR}"
 
 # User can specify hostnames or a file where the hostnames are (not both)
 if [[ ( "$HADOOP_SLAVES" != '' ) && ( "$HADOOP_SLAVE_NAMES" != '' ) ]] ; then
@@ -218,7 +225,7 @@ CLASSPATH=${CLASSPATH}:$HADOOP_COMMON_HOME/$HADOOP_COMMON_DIR'/*'
 
 # default log directory & file
 if [ "$HADOOP_LOG_DIR" = "" ]; then
-  HADOOP_LOG_DIR="$HADOOP_PREFIX/logs"
+  HADOOP_LOG_DIR="/var/log/hadoop"
 fi
 if [ "$HADOOP_LOGFILE" = "" ]; then
   HADOOP_LOGFILE='hadoop.log'
diff --git a/hadoop-common-project/hadoop-common/src/main/bin/hadoop-daemon.sh b/hadoop-common-project/hadoop-common/src/main/bin/hadoop-daemon.sh
index d2ef1cf..12cbb9e 100755
--- a/hadoop-common-project/hadoop-common/src/main/bin/hadoop-daemon.sh
+++ b/hadoop-common-project/hadoop-common/src/main/bin/hadoop-daemon.sh
@@ -102,7 +102,7 @@ fi
 
 # get log directory
 if [ "$HADOOP_LOG_DIR" = "" ]; then
-  export HADOOP_LOG_DIR="$HADOOP_PREFIX/logs"
+  export HADOOP_LOG_DIR="/var/log/hadoop"
 fi
 
 if [ ! -w "$HADOOP_LOG_DIR" ] ; then
diff --git a/hadoop-common-project/hadoop-kms/src/main/libexec/kms-config.sh b/hadoop-common-project/hadoop-kms/src/main/libexec/kms-config.sh
index 7c07b9a..1a2a6ac 100644
--- a/hadoop-common-project/hadoop-kms/src/main/libexec/kms-config.sh
+++ b/hadoop-common-project/hadoop-kms/src/main/libexec/kms-config.sh
@@ -101,7 +101,7 @@ if [ "${KMS_CONFIG}" != "${kms_config}" ]; then
 fi
 
 if [ "${KMS_LOG}" = "" ]; then
-  export KMS_LOG=${KMS_HOME}/logs
+  export KMS_LOG=/var/log/hadoop
   print "Setting KMS_LOG:           ${KMS_LOG}"
 else
   print "Using   KMS_LOG:           ${KMS_LOG}"
diff --git a/hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/libexec/httpfs-config.sh b/hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/libexec/httpfs-config.sh
index a2fe1c2..fb33ef1 100644
--- a/hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/libexec/httpfs-config.sh
+++ b/hadoop-hdfs-project/hadoop-hdfs-httpfs/src/main/libexec/httpfs-config.sh
@@ -101,7 +101,7 @@ if [ "${HTTPFS_CONFIG}" != "${httpfs_config}" ]; then
 fi
 
 if [ "${HTTPFS_LOG}" = "" ]; then
-  export HTTPFS_LOG=${HTTPFS_HOME}/logs
+  export HTTPFS_LOG=/var/log/hadoop
   print "Setting HTTPFS_LOG:           ${HTTPFS_LOG}"
 else
   print "Using   HTTPFS_LOG:           ${HTTPFS_LOG}"
diff --git a/hadoop-mapreduce-project/bin/mapred-config.sh b/hadoop-mapreduce-project/bin/mapred-config.sh
index b245ec9..6be06a3 100644
--- a/hadoop-mapreduce-project/bin/mapred-config.sh
+++ b/hadoop-mapreduce-project/bin/mapred-config.sh
@@ -41,7 +41,7 @@ fi
 
 # Only set locally to use in HADOOP_OPTS. No need to export.
 # The following defaults are useful when somebody directly invokes bin/mapred.
-HADOOP_MAPRED_LOG_DIR=${HADOOP_MAPRED_LOG_DIR:-${HADOOP_MAPRED_HOME}/logs}
+HADOOP_MAPRED_LOG_DIR=${HADOOP_MAPRED_LOG_DIR:-/var/log/hadoop}
 HADOOP_MAPRED_LOGFILE=${HADOOP_MAPRED_LOGFILE:-hadoop.log}
 HADOOP_MAPRED_ROOT_LOGGER=${HADOOP_MAPRED_ROOT_LOGGER:-${HADOOP_LOGLEVEL},console}
 
diff --git a/hadoop-yarn-project/hadoop-yarn/bin/yarn b/hadoop-yarn-project/hadoop-yarn/bin/yarn
index 552cef4..fd660b0 100644
--- a/hadoop-yarn-project/hadoop-yarn/bin/yarn
+++ b/hadoop-yarn-project/hadoop-yarn/bin/yarn
@@ -197,7 +197,7 @@ IFS=
 
 # default log directory & file
 if [ "$YARN_LOG_DIR" = "" ]; then
-  YARN_LOG_DIR="$HADOOP_YARN_HOME/logs"
+  YARN_LOG_DIR="/var/log/hadoop"
 fi
 if [ "$YARN_LOGFILE" = "" ]; then
   YARN_LOGFILE='yarn.log'
diff --git a/hadoop-yarn-project/hadoop-yarn/bin/yarn-config.sh b/hadoop-yarn-project/hadoop-yarn/bin/yarn-config.sh
index 3d67801..7fe6161 100644
--- a/hadoop-yarn-project/hadoop-yarn/bin/yarn-config.sh
+++ b/hadoop-yarn-project/hadoop-yarn/bin/yarn-config.sh
@@ -49,7 +49,12 @@ then
 fi
  
 # Allow alternate conf dir location.
-export YARN_CONF_DIR="${HADOOP_CONF_DIR:-$HADOOP_YARN_HOME/conf}"
+if [ -e "/etc/hadoop" ]
+then
+    export YARN_CONF_DIR="${HADOOP_CONF_DIR:-/etc/hadoop}"
+else
+    export YARN_CONF_DIR="${HADOOP_CONF_DIR:-/usr/share/defaults/hadoop}"
+fi
 
 #check to see it is specified whether to use the slaves or the
 # masters file
diff --git a/hadoop-yarn-project/hadoop-yarn/bin/yarn-daemon.sh b/hadoop-yarn-project/hadoop-yarn/bin/yarn-daemon.sh
index fbfa71d..c905c2b 100644
--- a/hadoop-yarn-project/hadoop-yarn/bin/yarn-daemon.sh
+++ b/hadoop-yarn-project/hadoop-yarn/bin/yarn-daemon.sh
@@ -76,7 +76,7 @@ fi
 
 # get log directory
 if [ "$YARN_LOG_DIR" = "" ]; then
-  export YARN_LOG_DIR="$HADOOP_YARN_HOME/logs"
+  export YARN_LOG_DIR="/var/log/hadoop"
 fi
 
 if [ ! -w "$YARN_LOG_DIR" ] ; then
diff --git a/hadoop-yarn-project/hadoop-yarn/conf/yarn-env.sh b/hadoop-yarn-project/hadoop-yarn/conf/yarn-env.sh
index 2fc693b..a4e7507 100644
--- a/hadoop-yarn-project/hadoop-yarn/conf/yarn-env.sh
+++ b/hadoop-yarn-project/hadoop-yarn/conf/yarn-env.sh
@@ -90,7 +90,7 @@ IFS=
 
 # default log directory & file
 if [ "$YARN_LOG_DIR" = "" ]; then
-  YARN_LOG_DIR="$HADOOP_YARN_HOME/logs"
+  YARN_LOG_DIR="/var/log/hadoop"
 fi
 if [ "$YARN_LOGFILE" = "" ]; then
   YARN_LOGFILE='yarn.log'
-- 
2.14.2

